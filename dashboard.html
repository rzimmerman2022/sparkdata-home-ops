<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleaning Progress Dashboard - SparkData Home Ops</title>
    <meta name="description" content="Watch cleaning progress in real-time">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVHDGBL70opBifmdnILzrUYEptQsMw708",
            authDomain: "sparkdata-cleaning-checklists.firebaseapp.com",
            projectId: "sparkdata-cleaning-checklists",
            storageBucket: "sparkdata-cleaning-checklists.firebasestorage.app",
            messagingSenderId: "825900465348",
            appId: "1:825900465348:web:d28f2742e527513311dd91"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Enable offline persistence
        db.enablePersistence({ synchronizeTabs: true })
            .catch((err) => {
                console.warn('Firebase persistence failed:', err.code);
            });
    </script>

    <style>
        :root {
            --primary: #0f172a;
            --secondary: #475569;
            --accent: #3b82f6;
            --accent-light: #dbeafe;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --surface: #ffffff;
            --surface-elevated: #f8fafc;
            --border: #e2e8f0;
            --border-strong: #cbd5e1;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.5;
            padding: 24px 16px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--accent);
            color: white;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Status Card */
        .status-card {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .status-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-indicator.active {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-indicator.completed {
            background: var(--secondary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.active {
            background: var(--success-light);
            color: #065f46;
        }

        .status-badge.completed {
            background: var(--border);
            color: var(--text-secondary);
        }

        /* Progress */
        .progress-card {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .progress-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .progress-percent {
            font-size: 32px;
            font-weight: 800;
            color: var(--accent);
        }

        .progress-bar-container {
            background: var(--surface-elevated);
            height: 16px;
            border-radius: 100px;
            overflow: hidden;
            border: 1px solid var(--border);
            margin-bottom: 12px;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--accent), #8b5cf6);
            height: 100%;
            width: 0%;
            border-radius: 100px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Timer */
        .timer-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .timer-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .timer-value {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
        }

        /* Section Cards */
        .sections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .section-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-progress {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent);
        }

        .section-tasks {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: var(--radius-sm);
            background: var(--surface-elevated);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .task-item.completed {
            background: var(--success-light);
            color: #065f46;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid var(--border-strong);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .task-item.completed .task-checkbox {
            background: var(--success);
            border-color: var(--success);
        }

        .task-item.completed .task-checkbox::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: 700;
        }

        /* Notes */
        .notes-card {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .notes-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .notes-content {
            background: var(--surface-elevated);
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            color: var(--text-secondary);
            min-height: 80px;
            white-space: pre-wrap;
        }

        .notes-empty {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .last-updated {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Error State */
        .error-state {
            background: var(--danger-light);
            border: 2px solid var(--danger);
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            margin: 40px 0;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .error-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--danger);
            margin-bottom: 8px;
        }

        .error-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: var(--text-secondary);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 16px 12px;
            }

            .header h1 {
                font-size: 24px;
            }

            .progress-percent {
                font-size: 28px;
            }

            .timer-value {
                font-size: 28px;
            }

            .sections-grid {
                grid-template-columns: 1fr;
            }

            .status-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-badge">SparkData Home Ops</div>
            <h1>Live Cleaning Dashboard</h1>
            <p class="header-subtitle">Watch progress in real-time</p>
        </header>

        <!-- Loading State (shown initially) -->
        <div id="loadingState" class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Finding active cleaning session...</p>
        </div>

        <!-- Error State (hidden by default) -->
        <div id="errorState" class="error-state" style="display: none;">
            <div class="error-icon">⚠️</div>
            <h2 class="error-title" id="errorTitle">Session Not Found</h2>
            <p class="error-message" id="errorMessage">The cleaning session could not be found.</p>
            <button class="btn btn-primary" onclick="window.location.href='index.html'">Go to Home</button>
        </div>

        <!-- Dashboard Content (hidden until loaded) -->
        <div id="dashboardContent" style="display: none;">
            <!-- Status Card -->
            <div class="status-card">
                <div class="status-row">
                    <div class="status-item">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span class="status-label">Status:</span>
                        <span class="status-badge" id="statusBadge">Loading...</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Started:</span>
                        <span class="status-value" id="startTime">--</span>
                    </div>
                    <div class="status-item">
                        <span class="last-updated" id="lastUpdated">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                            </svg>
                            Connecting...
                        </span>
                    </div>
                </div>
            </div>

            <!-- Progress Card -->
            <div class="progress-card">
                <div class="progress-header">
                    <span class="progress-label">Overall Progress</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
                <div class="progress-stats">
                    <span id="progressText">0 of 0 tasks completed</span>
                    <span id="sessionDuration">--</span>
                </div>
            </div>

            <!-- Sections Grid -->
            <div class="sections-grid" id="sectionsGrid">
                <!-- Sections will be dynamically populated -->
            </div>

            <!-- Notes Card -->
            <div class="notes-card">
                <h3 class="notes-title">Cleaner Notes</h3>
                <div class="notes-content" id="notesContent">
                    <span class="notes-empty">No notes yet</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>SparkData Home Ops © 2025</p>
        </footer>
    </div>

    <script>
        // Get session ID from URL (optional - if not provided, auto-find most recent)
        const urlParams = new URLSearchParams(window.location.search);
        const sessionIdFromUrl = urlParams.get('session');

        let unsubscribe = null; // Store listener unsubscribe function
        let sessionStartTime = null;
        let timerInterval = null;
        let currentSessionId = null;
        let sections = {}; // Will be populated dynamically from checklist HTML
        let checklistUrl = 'https://rzimmerman2022.github.io/sparkdata-home-ops/Deep_Clean_2025-12-10_Firestore_Sync.html'; // Public URL for universal access

        // Load checklist structure dynamically
        async function loadChecklistStructure() {
            try {
                // Try to fetch the checklist HTML
                const response = await fetch(checklistUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Find all sections
                const sectionElements = doc.querySelectorAll('section.section');
                sections = {};

                sectionElements.forEach(section => {
                    const titleEl = section.querySelector('.section-title');
                    if (!titleEl) return;

                    const sectionName = titleEl.textContent.trim();
                    const taskIds = [];

                    // Find all checkboxes in this section
                    const checkboxes = section.querySelectorAll('.task-checkbox');
                    checkboxes.forEach(cb => {
                        if (cb.id) {
                            taskIds.push(cb.id);
                        }
                    });

                    if (taskIds.length > 0) {
                        sections[sectionName] = taskIds;
                    }
                });

                console.log('Loaded checklist structure:', Object.keys(sections).length, 'sections,',
                    Object.values(sections).reduce((sum, arr) => sum + arr.length, 0), 'total tasks');

                if (Object.keys(sections).length === 0) {
                    throw new Error('No sections found in checklist');
                }

            } catch (error) {
                console.error('Error loading checklist structure:', error);
                console.error('Error details:', error.message);

                // Fallback: use hardcoded structure as backup
                console.warn('Falling back to hardcoded section structure');
                sections = {
                    'Master Bathroom': ['mba-curtain-rod', 'mba-showerhead', 'mba-tiles', 'mba-tub', 'mba-door', 'mba-drain', 'mba-faucet', 'mba-sink', 'mba-countertop', 'mba-mirror', 'mba-toilet-bowl', 'mba-toilet-ext', 'mba-exhaust', 'mba-baseboards', 'mba-floor', 'mba-trash'],
                    'Master Bedroom': ['mb-ceiling-fan', 'mb-corners', 'mb-vents', 'mb-windows', 'mb-window-tracks', 'mb-blinds', 'mb-furniture', 'mb-mirrors', 'mb-switches', 'mb-cable-mgmt', 'mb-baseboards', 'mb-vacuum', 'mb-carpet-clean'],
                    'Kitchen - Deep Appliances': ['k-brio', 'k-microwave-int', 'k-microwave-ext', 'k-dishwasher', 'k-fridge-int', 'k-fridge-ext', 'k-oven-int', 'k-oven-ext', 'k-stovetop', 'k-countertops', 'k-sink', 'k-faucet', 'k-garbage-can', 'k-table', 'k-chairs', 'k-baseboards', 'k-vacuum', 'k-floor'],
                    'Kitchen Organization': ['k-counter-items', 'k-food-cabinet', 'k-expired-food', 'k-fridge-expired', 'k-fridge-organize', 'guest-bath-cabinets'],
                    'Office': ['office-closet', 'office-storage-cube', 'office-ceiling-fan', 'office-corners', 'office-vents', 'office-desk', 'office-keyboard', 'office-mouse', 'office-tower', 'office-chair', 'office-glass-mat', 'office-baseboards', 'office-vacuum', 'office-carpet', 'office-cables'],
                    'Living Room': ['lr-ceiling-fan', 'lr-corners', 'lr-tv', 'lr-behind-tv', 'lr-lamps', 'lr-speakers', 'lr-furniture', 'lr-couch', 'lr-pet-area', 'lr-baseboards', 'lr-vacuum'],
                    'Whole House': ['whole-switches', 'whole-handles', 'whole-baseboards'],
                    'Outdoor & Storage': ['garage-return', 'outdoor-storage', 'towels-organize']
                };
                console.log('Using fallback structure:', Object.keys(sections).length, 'sections');
            }
        }

        // Initialize dashboard - load checklist structure then start
        async function initializeDashboard() {
            // Load checklist structure first
            await loadChecklistStructure();

            // Then start dashboard
            if (sessionIdFromUrl) {
                // Session ID provided in URL - use it directly
                currentSessionId = sessionIdFromUrl;
                console.log('Using session from URL:', currentSessionId);
                startDashboard(currentSessionId);
            } else {
                // No session ID - auto-find most recent active session
                console.log('No session ID in URL - searching for most recent active session...');
                findAndStartDashboard();
            }
        }

        // Start initialization
        initializeDashboard();

        // Auto-find most recent active session
        async function findAndStartDashboard() {
            try {
                const snapshot = await db.collection('sessions/dec10-2025/cleaners')
                    .where('status', '==', 'active')
                    .orderBy('startTime', 'desc')
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    showError('No Active Session', 'No cleaning session is currently in progress.<br><br>The dashboard will automatically show the next session when a cleaner clicks "Start Session".');
                    return;
                }

                const sessionDoc = snapshot.docs[0];
                currentSessionId = sessionDoc.id;
                console.log('Found active session:', currentSessionId);
                startDashboard(currentSessionId);
            } catch (error) {
                console.error('Error finding session:', error);
                showError('Connection Error', 'Failed to connect to Firebase. Please check your internet connection.');
            }
        }

        async function startDashboard(sessionId) {
            try {
                // Set up listener for ALL active cleaners (not just one session)
                const cleanersUnsubscribe = db.collection('sessions/dec10-2025/cleaners')
                    .where('status', '==', 'active')
                    .onSnapshot(async snapshot => {
                        if (snapshot.empty) {
                            showError('No Active Session', 'No cleaning session is currently in progress.');
                            return;
                        }

                        // Get all active cleaner sessions
                        const activeSessions = [];
                        snapshot.forEach(doc => {
                            activeSessions.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });

                        // Use the most recent session for display (or combine data)
                        const sessionData = activeSessions[0];

                        // Set up listener for task progress
                        const progressUnsubscribe = db.collection('sessions/dec10-2025/progress')
                            .onSnapshot(snapshot => {
                                const taskData = {};
                                snapshot.forEach(doc => {
                                    taskData[doc.id] = doc.data();
                                });

                                updateDashboard(sessionData, taskData, activeSessions);

                                // Show dashboard, hide loading
                                document.getElementById('loadingState').style.display = 'none';
                                document.getElementById('dashboardContent').style.display = 'block';
                            });

                        // Store unsubscribe functions
                        if (unsubscribe) {
                            unsubscribe();
                        }
                        unsubscribe = () => {
                            cleanersUnsubscribe();
                            progressUnsubscribe();
                        };
                    }, error => {
                        console.error('Listener error:', error);
                        showError('Connection Error', 'Failed to connect to Firebase. Please check your internet connection.');
                    });

            } catch (error) {
                console.error('Error starting dashboard:', error);
                showError('Connection Error', 'Failed to initialize dashboard. Please refresh the page.');
            }
        }

        function updateDashboard(sessionData, taskData, activeSessions = []) {
            // Update status - show combined info if multiple cleaners
            const isActive = sessionData.status === 'active';
            const statusIndicator = document.getElementById('statusIndicator');
            const statusBadge = document.getElementById('statusBadge');

            statusIndicator.className = 'status-indicator ' + (isActive ? 'active' : 'completed');
            statusBadge.className = 'status-badge ' + (isActive ? 'active' : 'completed');

            // Show number of active cleaners if more than one
            if (activeSessions.length > 1) {
                statusBadge.textContent = `${activeSessions.length} Cleaners Active`;
            } else {
                statusBadge.textContent = isActive ? 'In Progress' : 'Completed';
            }

            // Update start time - show earliest start time if multiple cleaners
            if (sessionData.startTime) {
                sessionStartTime = sessionData.startTime.toDate();

                // If multiple cleaners, find earliest start time
                if (activeSessions.length > 1) {
                    const earliestSession = activeSessions.reduce((earliest, session) => {
                        const sessionTime = session.startTime.toDate();
                        return sessionTime < earliest.startTime.toDate() ? session : earliest;
                    });
                    sessionStartTime = earliestSession.startTime.toDate();
                }

                const timeStr = sessionStartTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Show cleaner names if available
                if (activeSessions.length > 0) {
                    const cleanerNames = activeSessions.map(s => s.name).join(', ');
                    document.getElementById('startTime').textContent = `${timeStr} (${cleanerNames})`;
                } else {
                    document.getElementById('startTime').textContent = timeStr;
                }

                // Start timer if active
                if (isActive && !timerInterval) {
                    updateTimer();
                    timerInterval = setInterval(updateTimer, 60000); // Update every minute
                } else if (!isActive && timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }

            // Calculate progress from task data
            const allTaskIds = Object.values(sections).flat();
            const completedCount = allTaskIds.filter(id => taskData[id]?.completed).length;
            const totalCount = allTaskIds.length;
            const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

            // Update progress
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressText').textContent =
                `${completedCount} of ${totalCount} tasks completed`;

            // Update sections
            updateSections(taskData);

            // Update notes (not in current implementation, but keeping for future)
            const notesContent = document.getElementById('notesContent');
            if (sessionData.notes && sessionData.notes.trim()) {
                notesContent.textContent = sessionData.notes;
                notesContent.classList.remove('notes-empty');
            } else {
                notesContent.innerHTML = '<span class="notes-empty">No notes yet</span>';
            }

            // Update last updated timestamp
            const now = new Date();
            const lastUpdated = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdated').innerHTML = `
                <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                    <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
                </svg>
                Updated: ${lastUpdated}
            `;
        }

        function updateTimer() {
            if (!sessionStartTime) return;

            const now = new Date();
            const elapsed = now - sessionStartTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);

            let durationText = '';
            if (hours > 0) {
                durationText = `${hours}h ${minutes}m elapsed`;
            } else {
                durationText = `${minutes} min${minutes !== 1 ? 's' : ''} elapsed`;
            }

            document.getElementById('sessionDuration').textContent = durationText;
        }

        function updateSections(taskData) {
            const grid = document.getElementById('sectionsGrid');
            grid.innerHTML = '';

            Object.keys(sections).forEach(sectionName => {
                const taskIds = sections[sectionName];
                let completedCount = 0;

                taskIds.forEach(id => {
                    if (taskData[id]?.completed) {
                        completedCount++;
                    }
                });

                const sectionCard = document.createElement('div');
                sectionCard.className = 'section-card';

                const progressPercent = taskIds.length > 0 ? Math.round((completedCount / taskIds.length) * 100) : 0;

                sectionCard.innerHTML = `
                    <div class="section-header">
                        <h3 class="section-title">${sectionName}</h3>
                        <span class="section-progress">${completedCount}/${taskIds.length}</span>
                    </div>
                    <div style="background: var(--surface-elevated); height: 6px; border-radius: 100px; margin-bottom: 12px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, var(--accent), #8b5cf6); height: 100%; width: ${progressPercent}%; border-radius: 100px; transition: width 0.4s ease;"></div>
                    </div>
                `;

                grid.appendChild(sectionCard);
            });
        }

        function showError(title, message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').innerHTML = message;
        }

        // Cleanup listener on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        });
    </script>
</body>
</html>
